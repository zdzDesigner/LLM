# ğŸ” ä»£ç æœ€ä½³å®è·µæ·±åº¦åˆ†ææŠ¥å‘Šï¼šHTML5 Canvas Undo/Redo

## 1. ğŸ“‹ æ ¸å¿ƒç»“è®º (Executive Summary)
æœ¬åœ°ä»£ç åº“ç›®å‰**æœªå‘ç°**ç›¸å…³çš„ Canvas çŠ¶æ€ç®¡ç†å®ç°ã€‚
è¡Œä¸šæœ€ä½³å®è·µï¼ˆå¦‚ Gradio, Proteusï¼‰æ™®éé‡‡ç”¨ **Command Pattern (å‘½ä»¤æ¨¡å¼)** æ¥ç®¡ç†æ’¤é”€æ ˆï¼Œè€Œä¸æ˜¯ä¿å­˜å…¨é‡å¿«ç…§ã€‚è¿™ç§æ¨¡å¼åœ¨ `frontend/src/helpers/history.ts` æˆ– `core/commands.ts` ç­‰æ–‡ä»¶ä¸­å°¤ä¸ºå¸¸è§ã€‚

## 2. ğŸ  æœ¬åœ°ä»£ç åº“ç°çŠ¶ (Local Context)
**åˆ†ææ™ºèƒ½ä½“**: `explore`
**æœç´¢èŒƒå›´**: æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿ

### å‘ç°çš„æ¨¡å¼
- **æœªå‘ç°**: æœ¬åœ°æœç´¢æœªåŒ¹é…åˆ° `Canvas`ã€`HistoryManager` æˆ– `Command` ç›¸å…³çš„ç±»å®šä¹‰ã€‚
  - **ä½ç½®**: N/A
  - **ç®€è¿°**: å½“å‰é¡¹ç›®ä¼¼ä¹æ²¡æœ‰ç»˜å›¾çŠ¶æ€ç®¡ç†æ¨¡å—ã€‚

### å­˜åœ¨çš„é—®é¢˜
- [ ] **ç¼ºå¤±åŸºç¡€æ¶æ„**: éœ€è¦ä»é›¶æ„å»ºå†å²è®°å½•ç®¡ç†å™¨ã€‚
- [ ] **æ½œåœ¨é£é™©**: å¦‚æœç›´æ¥ä½¿ç”¨ `canvas.toDataURL()` è¿›è¡Œå¿«ç…§ä¿å­˜ï¼Œä¼šå¯¼è‡´ä¸¥é‡çš„å†…å­˜æ€§èƒ½é—®é¢˜ã€‚

## 3. ğŸŒ è¡Œä¸šæœ€ä½³å®è·µ (Industry Standards)
**åˆ†ææ™ºèƒ½ä½“**: `librarian` (Grep.app / GitHub Search)
**æ•°æ®æ¥æº**: Gradio, Proteus, Diffgram

### æ¨èæ–¹æ¡ˆï¼šCommand Pattern (å‘½ä»¤æ¨¡å¼)
å¤§å¤šæ•°æˆç†Ÿé¡¹ç›®ä½¿ç”¨åŒæ ˆç»“æ„ (`history`/`undone`) é…åˆ `Command` æ¥å£ã€‚

> æ¥æº: [gradio-app/gradio](https://github.com/gradio-app/gradio/blob/main/js/imageeditor/shared/core/commands.ts)
> **æ–‡ä»¶ä½ç½®**: `js/imageeditor/shared/core/commands.ts`

```typescript
// Gradio çš„å®ç°é€»è¾‘ (Line 85)
async execute(command: Command, context: ImageEditorContext): Promise<void> {
    await command.execute(context);
    this.history.push(command);
    // å…³é”®ç‚¹ï¼šæ‰§è¡Œæ–°å‘½ä»¤æ—¶ï¼Œå¿…é¡»åˆ‡æ–­å½“å‰çš„ "redo" è·¯å¾„
    this.history = this.history.next!; 
    this.current_history.update(() => this.history);
}
```

> æ¥æº: [diffgram/diffgram](https://github.com/diffgram/diffgram/blob/master/frontend/src/helpers/history.ts)
> **æ–‡ä»¶ä½ç½®**: `frontend/src/helpers/history.ts`

```typescript
// Diffgram çš„åŒæ ˆå®ç° (Line 8-25)
public push(command: CommandInterface) {
    this.undone_history = []; // æ¸…ç©ºé‡åšæ ˆ
    this.history.push(command);
    this.update_status();
}

public repush(): CommandInterface {
    if (!this.redo_posible) return null;
    const command = this.undone_history.pop();
    this.history.push(command); // ç§»åŠ¨å›å†å²æ ˆ
    this.update_status();
    return command;
}
```

> æ¥æº: [gezilinll/Proteus](https://github.com/gezilinll/Proteus/blob/main/packages/core/src/command/CommandHistory.ts)
> **æ–‡ä»¶ä½ç½®**: `packages/core/src/command/CommandHistory.ts`

```typescript
// Proteus çš„å®¹é‡é™åˆ¶å®ç° (Line 29)
// æ·»åŠ åˆ°å†å²
this.history.push(command);
this.currentIndex = this.history.length - 1;

// é™åˆ¶å†å²è®°å½•å¤§å°ï¼Œé˜²æ­¢å†…å­˜æº¢å‡º
if (this.history.length > this.maxHistorySize) {
  this.history.shift();
}
```

### å…³é”®è®¾è®¡ç‚¹
- **åŒæ ˆç®¡ç†**: ç»´æŠ¤ `history` (å·²æ‰§è¡Œ) å’Œ `undone_history` (å·²æ’¤é”€) ä¸¤ä¸ªæ•°ç»„ã€‚
- **å®¹é‡é™åˆ¶**: å¦‚ Proteus å®ç°ï¼Œæ£€æŸ¥ `maxHistorySize` å¹¶ç§»é™¤æ—§è®°å½•ã€‚
- **æ“ä½œåŸå­åŒ–**: æ¯ä¸ª `Command` å¿…é¡»åŒ…å« `execute()` å’Œ `undo()` æ–¹æ³•ã€‚

## 4. ğŸ’¡ ç»¼åˆå»ºè®® (Recommendation)

### ğŸš€ å»ºè®®å®æ–½æ–¹æ¡ˆ
1. **å‚è€ƒå®ç°**: å»ºè®®æ¨¡ä»¿ `diffgram` çš„ `src/helpers/history.ts`ï¼Œå› ä¸ºå®ƒé€»è¾‘æœ€æ¸…æ™°ï¼Œåˆ†ç¦»äº† `push` (æ‰§è¡Œ) å’Œ `repush` (é‡åš)ã€‚
2. **æ–‡ä»¶ç»“æ„**: 
   - åˆ›å»º `src/core/history/HistoryManager.ts`
   - åˆ›å»º `src/core/commands/BaseCommand.ts`

### âš ï¸ é¿å‘æŒ‡å— (Anti-patterns)
- âŒ **é¿å…å¿«ç…§**: ä¸è¦åƒæŸäº›ç®€å•æ•™ç¨‹é‚£æ ·ä½¿ç”¨ `canvas.toDataURL()` ä¿å­˜å†å²ï¼Œè¿™åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä¸å¯è¡Œã€‚
- âœ… **æ¨è**: å®ç° `Command` æ¥å£æ—¶ï¼Œä¿å­˜"æ“ä½œçš„æ•°æ®"ï¼ˆå¦‚ï¼šæ·»åŠ äº†ä¸€ä¸ªçŸ©å½¢ï¼Œåæ ‡x,yï¼‰ï¼Œè€Œä¸æ˜¯ä¿å­˜"ç”»å¸ƒçš„åƒç´ "ã€‚

---
*Generated by Code Example Searcher Skill*
