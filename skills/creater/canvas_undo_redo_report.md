# ğŸ” ä»£ç æœ€ä½³å®è·µæ·±åº¦åˆ†ææŠ¥å‘Šï¼šHTML5 Canvas Undo/Redo

## 1. ğŸ“‹ æ ¸å¿ƒç»“è®º (Executive Summary)
æœ¬åœ°ä»£ç åº“ç›®å‰**æœªå‘ç°** Canvas æˆ– Undo/Redo çš„ç›¸å…³å®ç°ã€‚
é’ˆå¯¹ Canvas æ’¤é”€é‡åšåŠŸèƒ½ï¼Œè¡Œä¸šä¸»æµé‡‡ç”¨äº† **Command Pattern (å‘½ä»¤æ¨¡å¼)** ä»¥å®ç°é«˜æ€§èƒ½æ“ä½œå›æº¯ï¼Œè€Œå¯¹äºç®€å•åœºæ™¯åˆ™ä½¿ç”¨ **Memento Pattern (å¿«ç…§æ¨¡å¼)**ã€‚å»ºè®®åœ¨å¤§å‹ç»˜å›¾åº”ç”¨ä¸­ä¼˜å…ˆé‡‡ç”¨å‘½ä»¤æ¨¡å¼ä»¥å‡å°‘å†…å­˜å¼€é”€ã€‚

## 2. ğŸ  æœ¬åœ°ä»£ç åº“ç°çŠ¶ (Local Context)
**åˆ†ææ™ºèƒ½ä½“**: `explore` (Explore Agent)
**æœç´¢èŒƒå›´**: æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿ

### å‘ç°çš„æ¨¡å¼
- **æœªå‘ç°**: æœ¬åœ°æœªæœç´¢åˆ° `Canvas` æ“ä½œç±»æˆ– `History/Command` ç›¸å…³çš„çŠ¶æ€ç®¡ç†é€»è¾‘ã€‚

### å­˜åœ¨çš„é—®é¢˜
- [ ] **ä»é›¶å¼€å§‹**: éœ€è¦ä»å¤´æ„å»ºçŠ¶æ€ç®¡ç†åŸºç¡€è®¾æ–½ã€‚
- [ ] **æ€§èƒ½é£é™©**: è‹¥é”™è¯¯é€‰æ‹© `toDataURL()` å…¨é‡å¿«ç…§æ–¹æ¡ˆï¼Œåœ¨ 5000px+ å¤§ç”»å¸ƒä¸‹ä¼šå¯¼è‡´ä¸¥é‡çš„å†…å­˜æ³„æ¼å’Œå¡é¡¿ã€‚

## 3. ğŸŒ è¡Œä¸šæœ€ä½³å®è·µ (Industry Standards)
**åˆ†ææ™ºèƒ½ä½“**: `librarian` (WebSearch & GitHub Search)
**æ•°æ®æ¥æº**: Excalidraw, Fabric.js, StackOverflow, Dev.to

### æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | æœºåˆ¶ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
| :--- | :--- | :--- | :--- | :--- |
| **Command Pattern** | è®°å½•æ“ä½œæŒ‡ä»¤ (Action) | å†…å­˜å ç”¨æä½ï¼Œå¯å®ç°ç²¾ç»†å›æ”¾ | å®ç°å¤æ‚ï¼Œéœ€åºåˆ—åŒ–æ‰€æœ‰æ“ä½œ | çŸ¢é‡ç»˜å›¾ (Excalidraw) |
| **Memento (Snapshot)** | `canvas.toDataURL()` | å®ç°ç®€å•ï¼Œä»£ç é‡å°‘ | **å†…å­˜æé«˜**ï¼Œå¤§å›¾å¡é¡¿ | åƒç´ ç»˜å›¾ (Pixel Art), å°ç”»å¸ƒ |

### æ¨èæ–¹æ¡ˆ (Command Pattern)
> æ¥æº: [Excalidraw History Implementation](https://github.com/excalidraw/excalidraw)

ä½¿ç”¨åŒæ ˆ (`undoStack`, `redoStack`) é…åˆå‘½ä»¤å¯¹è±¡ï¼š

```typescript
// 1. å®šä¹‰å‘½ä»¤æ¥å£
interface Command {
  execute(): void;
  undo(): void;
}

// 2. å®ç°å…·ä½“å‘½ä»¤ (å¦‚ï¼šæ·»åŠ çŸ©å½¢)
class AddRectCommand implements Command {
  constructor(private canvas: Canvas, private rect: Rect) {}
  
  execute() {
    this.canvas.add(this.rect);
    this.canvas.render();
  }
  
  undo() {
    this.canvas.remove(this.rect);
    this.canvas.render();
  }
}

// 3. å†å²ç®¡ç†å™¨
class HistoryManager {
  private undoStack: Command[] = [];
  private redoStack: Command[] = [];

  execute(command: Command) {
    command.execute();
    this.undoStack.push(command);
    this.redoStack = []; // æ¸…ç©ºé‡åšæ ˆ
  }

  undo() {
    const cmd = this.undoStack.pop();
    if (cmd) {
      cmd.undo();
      this.redoStack.push(cmd);
    }
  }
}
```

### å…³é”®è®¾è®¡ç‚¹
- **ä¸å¯å˜æ•°æ® (Immutability)**: æ¯æ¬¡æ“ä½œç”Ÿæˆæ–°çš„çŠ¶æ€å¯¹è±¡ï¼ˆé…åˆ immer.js æ•ˆæœæ›´ä½³ï¼‰ã€‚
- **æœ€å¤§æ ˆé™åˆ¶**: é™åˆ¶ `undoStack.length` (å¦‚ 50 æ­¥)ï¼Œé˜²æ­¢é•¿æœŸè¿è¡Œå†…å­˜æº¢å‡ºã€‚
- **æ··åˆæ¨¡å¼**: å…³é”®èŠ‚ç‚¹å­˜å¿«ç…§ (Checkpoint)ï¼Œä¸­é—´æ­¥éª¤å­˜å‘½ä»¤ï¼Œå¹³è¡¡æ€§èƒ½ä¸æ¢å¤é€Ÿåº¦ã€‚

## 4. ğŸ’¡ ç»¼åˆå»ºè®® (Recommendation)

### ğŸš€ å»ºè®®å®æ–½æ–¹æ¡ˆ
1. **åŸºç¡€æ¶æ„**: åˆ›å»º `HistoryManager` ç±»ï¼Œç®¡ç† `undo/redo` æ ˆã€‚
2. **æŠ½è±¡æŒ‡ä»¤**: å°†æ‰€æœ‰ Canvas æ“ä½œï¼ˆç”»ç¬”ã€ç§»åŠ¨ã€ç¼©æ”¾ï¼‰å°è£…ä¸º `Command` å¯¹è±¡ã€‚
3. **åºåˆ—åŒ–**: ç¡®ä¿æ¯ä¸ª Command éƒ½èƒ½è¢« JSON åºåˆ—åŒ–ï¼Œä»¥ä¾¿æœªæ¥æ”¯æŒ"ä¿å­˜è‰ç¨¿"åŠŸèƒ½ã€‚

### âš ï¸ é¿å‘æŒ‡å— (Anti-patterns)
- âŒ **ç»å¯¹é¿å…**: åœ¨ `mousemove` äº‹ä»¶ä¸­é¢‘ç¹ä¿å­˜å…¨é‡å¿«ç…§ (`canvas.toDataURL()`)ã€‚è¿™æ˜¯å¯¼è‡´æµè§ˆå™¨å´©æºƒçš„é¦–è¦åŸå› ã€‚
- âŒ **é¿å…**: ä¾èµ– Canvas åŸç”ŸçŠ¶æ€ (`ctx.save()/restore()`) åšåº”ç”¨çº§æ’¤é”€ï¼Œå®ƒåªé’ˆå¯¹ Context å±æ€§ï¼Œä¸åŒ…å«å›¾å½¢å¯¹è±¡ã€‚
- âœ… **æ¨è**: å¦‚æœæ˜¯åƒç´ çº§ç»˜å›¾ï¼ˆå¦‚ç”»æ¿ï¼‰ï¼Œå°†ç”»å¸ƒåˆ‡ç‰‡ (Tiles) ä»…ä¿å­˜å˜åŠ¨çš„åŒºåŸŸã€‚

---
*Generated by Code Example Searcher Skill*
